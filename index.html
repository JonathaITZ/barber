<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Don Barber - Agendamento Premium</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React e Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #09090b;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #f59e0b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .btn-primary {
            background-color: #f59e0b;
            color: #000;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s;
        }
        .btn-primary:active { transform: scale(0.95); }
        .btn-primary:disabled { 
            background-color: #3f3f46;
            color: #71717a;
            transform: scale(1);
            cursor: not-allowed;
        }

        .service-card-selected {
            border-color: #f59e0b !important;
            background-color: rgba(245, 158, 11, 0.1) !important;
        }
    </style>
</head>
<body class="text-zinc-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // --- CONFIGURA√á√ÉO SUPABASE ---
        const SUPABASE_URL = "https://qokhszjgkzcsauvkdlia.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFva2hzempna3pjc2F1dmtkbGlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODM4MDgsImV4cCI6MjA4NzE1OTgwOH0.IfqVxnwux81PXVAqhDe7ftRXePHM4cmg3w6VHTN53n8";
        
        const { createClient } = supabase;
        const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const WHATSAPP_BARBEARIA = "5583996190083"; 
        const ADMIN_PIN = "1234";

        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = `<i data-lucide="${name}" width="${size}" height="${size}" class="${className}"></i>`;
                    window.lucide.createIcons({ root: ref.current });
                }
            }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', width: size, height: size }} />;
        };

        function App() {
            const [view, setView] = useState('user'); 
            const [adminTab, setAdminTab] = useState('agenda'); 
            const [step, setStep] = useState(1);
            
            const [bookings, setBookings] = useState([]);
            const [services, setServices] = useState([]);
            const [config, setConfig] = useState({ maxPerSlot: 2 });
            
            const [pinInput, setPinInput] = useState('');
            const [showPinModal, setShowPinModal] = useState(false);
            const [loading, setLoading] = useState(false);
            const [initialLoading, setInitialLoading] = useState(true);
            const [error, setError] = useState(null);
            const [errorDetail, setErrorDetail] = useState(null);

            // Agora 'services' na sele√ß√£o √© um array
            const [selection, setSelection] = useState({ services: [], date: '', time: '', name: '', phone: '' });
            const [newService, setNewService] = useState({ name: '', price: '', duration: '' });

            const fetchData = useCallback(async () => {
                setError(null);
                try {
                    const [resBookings, resServices, resSettings] = await Promise.all([
                        client.from('bookings').select('*').order('date', { ascending: true }),
                        client.from('services').select('*'),
                        client.from('settings').select('*').eq('id', 'global').maybeSingle()
                    ]);

                    if (resBookings.error) throw resBookings.error;
                    if (resServices.error) throw resServices.error;

                    setBookings(resBookings.data || []);
                    setServices(resServices.data || []);
                    if (resSettings.data) setConfig(resSettings.data);
                } catch (err) {
                    setError("Erro ao ligar ao servidor.");
                    setErrorDetail(err.message);
                } finally {
                    setInitialLoading(false);
                }
            }, []);

            useEffect(() => {
                fetchData();
                const channel = client.channel('db-changes').subscribe();
                return () => client.removeChannel(channel);
            }, [fetchData]);

            const getVagasDisponiveis = (date, time) => {
                const ocupados = bookings.filter(b => b.date === date && b.time === time).length;
                return (Number(config.maxPerSlot) || 2) - ocupados;
            };

            // Fun√ß√£o para alternar sele√ß√£o de servi√ßo
            const toggleService = (service) => {
                setSelection(prev => {
                    const exists = prev.services.find(s => s.id === service.id);
                    if (exists) {
                        return { ...prev, services: prev.services.filter(s => s.id !== service.id) };
                    } else {
                        return { ...prev, services: [...prev.services, service] };
                    }
                });
            };

            // C√°lculo do total selecionado
            const totalSelection = useMemo(() => {
                return selection.services.reduce((acc, s) => {
                    const price = parseFloat(s.price.replace(/[^\d,.]/g, '').replace(',', '.'));
                    return acc + (isNaN(price) ? 0 : price);
                }, 0);
            }, [selection.services]);

            const handleBooking = async (e) => {
                e.preventDefault();
                if (selection.phone.length < 10) return;
                
                setLoading(true);
                try {
                    // Prepara o objeto de servi√ßo para o banco (lista de nomes e total)
                    const serviceSummary = {
                        items: selection.services.map(s => ({ name: s.name, price: s.price })),
                        total: `R$ ${totalSelection.toFixed(2)}`.replace('.', ',')
                    };

                    const { error: bErr } = await client.from('bookings').insert([{
                        name: selection.name,
                        phone: selection.phone,
                        date: selection.date,
                        time: selection.time,
                        service: serviceSummary // Salva como JSONB
                    }]);
                    if (bErr) throw bErr;
                    setStep(5);
                } catch (err) {
                    setError("Falha ao gravar agendamento.");
                    setErrorDetail(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const addService = async () => {
                if (!newService.name) return;
                setLoading(true);
                await client.from('services').insert([newService]);
                setNewService({ name: '', price: '', duration: '' });
                fetchData();
                setLoading(false);
            };

            const deleteService = async (id) => {
                await client.from('services').delete().eq('id', id);
                fetchData();
            };

            const deleteBooking = async (id) => {
                await client.from('bookings').delete().eq('id', id);
                fetchData();
            };

            const updateCapacity = async (val) => {
                const v = parseInt(val);
                setConfig({ maxPerSlot: v });
                await client.from('settings').upsert({ id: 'global', maxPerSlot: v });
            };

            const handlePhoneInput = (e) => {
                const val = e.target.value.replace(/\D/g, ''); 
                if (val.length <= 11) setSelection({...selection, phone: val});
            };

            return (
                <div className="min-h-screen flex flex-col pb-24 max-w-[600px] mx-auto bg-zinc-950 border-x border-white/5 shadow-2xl relative">
                    
                    <header className="px-6 pt-8 pb-4 bg-zinc-900/50 sticky top-0 z-40 backdrop-blur-md border-b border-white/5">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="p-2.5 bg-amber-500 rounded-xl text-black shadow-lg">
                                    <Icon name="scissors" size={24} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-black italic uppercase tracking-tighter leading-none">Don <span className="text-amber-500">Barber</span></h1>
                                    <span className="text-[10px] font-bold text-amber-500/50 tracking-widest uppercase block mt-1">
                                        {view === 'user' ? 'Agendamento' : 'Painel Staff'}
                                    </span>
                                </div>
                            </div>
                            {view === 'admin' && (
                                <button onClick={() => setView('user')} className="p-2 bg-zinc-800 rounded-full text-zinc-400 hover:text-white transition-colors">
                                    <Icon name="log-out" size={18} />
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="flex-1 px-4 py-6">
                        {error && (
                            <div className="mb-6 p-4 bg-red-500/10 border border-red-500/20 rounded-2xl text-red-400 text-xs fade-in">
                                <p className="font-bold uppercase tracking-tighter flex items-center gap-2"><Icon name="alert-triangle" size={14} /> {error}</p>
                                <button onClick={fetchData} className="underline mt-2">Tentar Reconectar</button>
                            </div>
                        )}

                        {view === 'user' ? (
                            <div className="fade-in">
                                <div className="bg-zinc-900/40 rounded-[2.5rem] border border-zinc-800/50 p-6 shadow-2xl backdrop-blur-sm">
                                    
                                    {/* Passo 1: Multi-Sele√ß√£o de Servi√ßos */}
                                    {step === 1 && (
                                        <div className="space-y-4">
                                            <div className="px-2">
                                                <h2 className="text-xl font-black italic uppercase">Servi√ßos</h2>
                                                <p className="text-xs text-zinc-500 font-medium">Selecione um ou mais servi√ßos abaixo:</p>
                                            </div>

                                            <div className="grid gap-3">
                                                {services.length > 0 ? services.map(s => {
                                                    const isSelected = selection.services.find(item => item.id === s.id);
                                                    return (
                                                        <button key={s.id} onClick={() => toggleService(s)} 
                                                            className={`w-full flex items-center justify-between p-5 rounded-3xl border transition-all text-left ${isSelected ? 'service-card-selected' : 'bg-zinc-800/40 border-zinc-700/50'}`}>
                                                            <div className="flex items-center gap-4">
                                                                <div className={`p-3 rounded-2xl transition-colors ${isSelected ? 'bg-amber-500 text-black' : 'bg-zinc-700/50 text-amber-500'}`}>
                                                                    <Icon name={isSelected ? "check" : "plus"} />
                                                                </div>
                                                                <div>
                                                                    <p className="font-bold text-base leading-tight">{s.name}</p>
                                                                    <p className="text-xs text-zinc-500 font-medium">{s.duration}</p>
                                                                </div>
                                                            </div>
                                                            <span className="font-black text-amber-500 text-lg">{s.price}</span>
                                                        </button>
                                                    );
                                                }) : !initialLoading && <div className="text-center py-12 opacity-30 italic text-sm">Carregando cat√°logo...</div>}
                                            </div>

                                            {selection.services.length > 0 && (
                                                <div className="pt-4 sticky bottom-0">
                                                    <button onClick={() => setStep(2)} className="w-full py-5 btn-primary rounded-3xl shadow-xl shadow-amber-500/20 flex items-center justify-center gap-3">
                                                        <span>PR√ìXIMO</span>
                                                        <span className="bg-black/20 px-3 py-1 rounded-full text-xs">Total: R$ {totalSelection.toFixed(2).replace('.', ',')}</span>
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Passo 2: Data */}
                                    {step === 2 && (
                                        <div className="space-y-6 fade-in">
                                            <h2 className="text-xl font-black italic uppercase">Quando?</h2>
                                            <div className="bg-zinc-800/50 p-4 rounded-3xl border border-zinc-700/50">
                                                <input type="date" min={new Date().toISOString().split('T')[0]} 
                                                    className="w-full bg-transparent p-4 text-white text-lg font-bold outline-none [color-scheme:dark]" 
                                                    onChange={e => setSelection({...selection, date: e.target.value})} />
                                            </div>
                                            <button disabled={!selection.date} onClick={() => setStep(3)} className="w-full py-5 btn-primary rounded-3xl">VER HOR√ÅRIOS</button>
                                            <button onClick={() => setStep(1)} className="w-full text-zinc-500 font-bold text-xs uppercase">Voltar</button>
                                        </div>
                                    )}

                                    {/* Passo 3: Hor√°rio */}
                                    {step === 3 && (
                                        <div className="space-y-6 fade-in">
                                            <h2 className="text-xl font-black text-center italic uppercase">Hor√°rios</h2>
                                            <div className="grid grid-cols-2 gap-3">
                                                {['09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00'].map(t => {
                                                    const vagas = getVagasDisponiveis(selection.date, t);
                                                    const esgotado = vagas <= 0;
                                                    return (
                                                        <button key={t} disabled={esgotado} onClick={() => {setSelection({...selection, time: t}); setStep(4)}} 
                                                            className={`py-5 rounded-2xl border font-black transition-all relative ${esgotado ? 'bg-zinc-950 border-zinc-900 text-zinc-800' : 'bg-zinc-800/80 border-zinc-700/50 active:bg-amber-500 active:text-black'}`}>
                                                            {t}
                                                            {!esgotado && <span className="absolute top-1 right-2 text-[8px] text-amber-500/50 uppercase">{vagas} vagas</span>}
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                            <button onClick={() => setStep(2)} className="w-full text-zinc-500 font-bold text-xs uppercase pt-4">Mudar Dia</button>
                                        </div>
                                    )}

                                    {/* Passo 4: Dados e Resumo */}
                                    {step === 4 && (
                                        <form onSubmit={handleBooking} className="space-y-6 fade-in">
                                            <h2 className="text-xl font-black italic uppercase">Resumo e Dados</h2>
                                            
                                            <div className="p-5 bg-amber-500/5 rounded-3xl border border-amber-500/10 space-y-2">
                                                <div className="flex flex-wrap gap-1">
                                                    {selection.services.map(s => (
                                                        <span key={s.id} className="text-[10px] bg-amber-500 text-black font-black px-2 py-0.5 rounded-full uppercase tracking-tighter">
                                                            {s.name}
                                                        </span>
                                                    ))}
                                                </div>
                                                <p className="text-base text-zinc-300 font-medium italic">{selection.date} √†s {selection.time}</p>
                                                <p className="text-amber-500 font-black text-lg">Total: R$ {totalSelection.toFixed(2).replace('.', ',')}</p>
                                            </div>

                                            <div className="space-y-4">
                                                <input required placeholder="Teu Nome" className="w-full bg-zinc-800/80 p-5 rounded-2xl border border-zinc-700/50 outline-none focus:border-amber-500 text-white" 
                                                    value={selection.name} onChange={e => setSelection({...selection, name: e.target.value})} />
                                                
                                                <div className="space-y-1">
                                                    <div className="flex justify-between px-2"><label className="text-[10px] font-black text-zinc-500 uppercase">WhatsApp</label></div>
                                                    <input required type="tel" placeholder="DDD + N√∫mero" className="w-full bg-zinc-800/80 p-5 rounded-2xl border border-zinc-700/50 outline-none focus:border-amber-500 text-white" 
                                                        value={selection.phone} onChange={handlePhoneInput} />
                                                </div>
                                            </div>

                                            <button type="submit" disabled={loading || selection.phone.length < 10 || !selection.name} className="w-full py-5 btn-primary rounded-3xl shadow-xl">
                                                {loading ? 'Processando...' : 'CONFIRMAR AGENDAMENTO'}
                                            </button>
                                        </form>
                                    )}

                                    {step === 5 && (
                                        <div className="text-center py-10 fade-in">
                                            <Icon name="check-circle" size={64} className="text-green-500 mx-auto mb-6" />
                                            <h2 className="text-3xl font-black uppercase italic mb-8 tracking-tighter text-white">Pronto!</h2>
                                            <button onClick={() => {
                                                const serviceList = selection.services.map(s => s.name).join(", ");
                                                const msg = `Ol√°! Agendei na Don Barber:\n\n‚úÇ Servi√ßos: ${serviceList}\nüìÖ Data: ${selection.date}\n‚è∞ Hora: ${selection.time}\nüí∞ Total: R$ ${totalSelection.toFixed(2)}\nüë§ Nome: ${selection.name}`;
                                                window.open(`https://wa.me/${WHATSAPP_BARBEARIA}?text=${encodeURIComponent(msg)}`, '_blank');
                                            }} className="w-full py-5 bg-[#25D366] text-white font-black rounded-3xl flex items-center justify-center gap-3 shadow-xl">
                                                <Icon name="message-circle" /> AVISAR NO WHATSAPP
                                            </button>
                                            <button onClick={() => window.location.reload()} className="mt-8 text-zinc-500 text-[10px] font-black uppercase tracking-widest">Novo Agendamento</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : (
                            /* PAINEL STAFF */
                            <div className="fade-in space-y-6">
                                <div className="flex bg-zinc-800 p-1.5 rounded-2xl border border-zinc-700 mb-6">
                                    <button onClick={() => setAdminTab('agenda')} className={`flex-1 py-3 rounded-xl font-black text-[10px] uppercase ${adminTab === 'agenda' ? 'bg-amber-500 text-black shadow-lg' : 'text-zinc-500'}`}>Agenda</button>
                                    <button onClick={() => setAdminTab('config')} className={`flex-1 py-3 rounded-xl font-black text-[10px] uppercase ${adminTab === 'config' ? 'bg-amber-500 text-black shadow-lg' : 'text-zinc-500'}`}>Servi√ßos</button>
                                </div>

                                {adminTab === 'agenda' ? (
                                    <div className="space-y-4">
                                        {bookings.length === 0 ? <p className="text-center py-20 opacity-30 italic">Sem agendamentos</p> : 
                                            bookings.map(b => {
                                                const serviceInfo = b.service || {};
                                                const items = Array.isArray(serviceInfo.items) ? serviceInfo.items : [{name: 'Servi√ßo √önico'}];
                                                return (
                                                    <div key={b.id} className="bg-zinc-900/80 p-5 rounded-[2rem] border border-zinc-800 flex items-center justify-between shadow-lg">
                                                        <div className="flex items-center gap-4">
                                                            <div className="w-12 h-12 bg-zinc-800 rounded-2xl flex items-center justify-center text-amber-500 font-black border border-zinc-700">{b.time?.split(':')[0]}</div>
                                                            <div>
                                                                <p className="font-bold text-white uppercase text-sm leading-none">{b.name}</p>
                                                                <div className="flex flex-wrap gap-1 mt-1">
                                                                    {items.map((it, idx) => (
                                                                        <span key={idx} className="text-[8px] text-zinc-500 font-bold uppercase">{it.name}{idx < items.length-1 ? ' ‚Ä¢' : ''}</span>
                                                                    ))}
                                                                </div>
                                                                <p className="text-[10px] text-amber-500/50 font-bold uppercase italic">{b.date}</p>
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => deleteBooking(b.id)} className="p-3 bg-red-500/10 text-red-500 rounded-2xl"><Icon name="trash-2" size={18}/></button>
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        }
                                    </div>
                                ) : (
                                    <div className="space-y-6">
                                        <div className="bg-zinc-900/80 p-6 rounded-[2.5rem] border border-zinc-800 space-y-3">
                                            <h3 className="text-[10px] font-black text-zinc-500 uppercase px-2 italic tracking-widest">Novo Servi√ßo</h3>
                                            <input placeholder="Nome" className="w-full bg-zinc-800 p-4 rounded-2xl outline-none border border-zinc-700 text-white text-sm" value={newService.name} onChange={e => setNewService({...newService, name: e.target.value})} />
                                            <div className="grid grid-cols-2 gap-3">
                                                <input placeholder="Pre√ßo (R$)" className="w-full bg-zinc-800 p-4 rounded-2xl outline-none border border-zinc-700 text-white text-sm" value={newService.price} onChange={e => setNewService({...newService, price: e.target.value})} />
                                                <input placeholder="Tempo" className="w-full bg-zinc-800 p-4 rounded-2xl outline-none border border-zinc-700 text-white text-sm" value={newService.duration} onChange={e => setNewService({...newService, duration: e.target.value})} />
                                            </div>
                                            <button onClick={addService} className="w-full py-4 bg-white text-black font-black rounded-2xl uppercase text-[10px] hover:bg-amber-500 transition-colors">Salvar Servi√ßo</button>
                                        </div>

                                        <div className="grid gap-2">
                                            {services.map(s => (
                                                <div key={s.id} className="bg-zinc-900/40 p-4 rounded-2xl border border-zinc-800 flex justify-between items-center px-6">
                                                    <span className="font-bold text-sm italic">{s.name} ({s.price})</span>
                                                    <button onClick={() => deleteService(s.id)} className="text-zinc-700 hover:text-red-500 p-2"><Icon name="trash-2" size={16}/></button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-zinc-900/95 backdrop-blur-xl border-t border-white/5 px-10 py-5 z-50 rounded-t-[2.5rem] shadow-2xl max-w-[600px] mx-auto flex justify-between items-center">
                        <button onClick={() => {setView('user'); setStep(1)}} className={`flex flex-col items-center gap-1.5 transition-colors ${view === 'user' ? 'text-amber-500' : 'text-zinc-600'}`}>
                            <Icon name="home" size={24} /><span className="text-[8px] font-black uppercase italic">In√≠cio</span>
                        </button>
                        <div className="w-px h-6 bg-zinc-800"></div>
                        <button onClick={() => setShowPinModal(true)} className={`flex flex-col items-center gap-1.5 transition-colors ${view === 'admin' ? 'text-amber-500' : 'text-zinc-600'}`}>
                            <Icon name="lock" size={24} /><span className="text-[8px] font-black uppercase italic">Staff</span>
                        </button>
                    </nav>

                    {/* PIN Modal */}
                    {showPinModal && (
                        <div className="fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-6 backdrop-blur-md">
                            <div className="w-full max-w-xs text-center space-y-8 animate-in fade-in zoom-in duration-300">
                                <div className="w-20 h-20 bg-amber-500/10 text-amber-500 rounded-3xl flex items-center justify-center mx-auto rotate-6 border border-amber-500/20 shadow-2xl">
                                    <Icon name="lock" size={36} />
                                </div>
                                <div className="space-y-2">
                                    <h3 className="text-2xl font-black uppercase italic text-white tracking-tighter">√Årea Staff</h3>
                                    <p className="text-zinc-500 text-sm">Insira o c√≥digo de acesso</p>
                                </div>
                                <input type="password" inputMode="numeric" maxLength={4} autoFocus className="w-full bg-zinc-900 border border-zinc-800 rounded-3xl py-6 text-center text-4xl font-black tracking-[0.4em] outline-none text-white focus:border-amber-500" 
                                    value={pinInput} onChange={e => {
                                        setPinInput(e.target.value);
                                        if (e.target.value === ADMIN_PIN) { setView('admin'); setShowPinModal(false); setPinInput(''); fetchData(); }
                                    }} 
                                />
                                <button onClick={() => setShowPinModal(false)} className="text-zinc-600 font-bold uppercase text-[10px]">Cancelar</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
